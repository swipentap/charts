apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "cockroachdb.fullname" . }}
  namespace: {{ include "cockroachdb.namespace" . }}
  labels:
    {{- include "cockroachdb.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
spec:
  serviceName: {{ include "cockroachdb.fullname" . }}
  replicas: {{ .Values.cockroachdb.replicaCount }}
  selector:
    matchLabels:
      {{- include "cockroachdb.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: database
  template:
    metadata:
      labels:
        {{- include "cockroachdb.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: database
    spec:
      containers:
      - name: cockroachdb
        image: "{{ .Values.cockroachdb.image.repository }}:{{ .Values.cockroachdb.image.tag }}"
        imagePullPolicy: {{ .Values.cockroachdb.image.pullPolicy }}
        ports:
        - containerPort: {{ .Values.cockroachdb.service.httpPort }}
          name: http
        - containerPort: {{ .Values.cockroachdb.service.sqlPort }}
          name: sql
        command:
        - /bin/bash
        - -ecx
        - |
          set -e
          POD_INDEX=$(hostname | sed 's/.*-\([0-9]*\)$/\1/')
          JOIN_LIST=""
          # Only join to nodes with lower index (already running)
          for i in $(seq 0 $((POD_INDEX - 1))); do
            if [ -n "$JOIN_LIST" ]; then
              JOIN_LIST="$JOIN_LIST,"
            fi
            JOIN_LIST="${JOIN_LIST}{{ include "cockroachdb.fullname" . }}-${i}.{{ include "cockroachdb.fullname" . }}.{{ include "cockroachdb.namespace" . }}.svc.cluster.local:{{ .Values.cockroachdb.service.sqlPort }}"
          done
          # For the first node (index 0), start without --join to initialize cluster
          if [ "$POD_INDEX" -eq "0" ]; then
            /cockroach/cockroach start \
              --insecure \
              --http-addr=0.0.0.0:{{ .Values.cockroachdb.service.httpPort }} \
              --listen-addr=0.0.0.0:{{ .Values.cockroachdb.service.sqlPort }} \
              --advertise-addr=$(hostname -f):{{ .Values.cockroachdb.service.sqlPort }} \
              --cache=.25 \
              --max-sql-memory=.25
          else
            # For subsequent nodes, join to existing nodes
            /cockroach/cockroach start \
              --insecure \
              --http-addr=0.0.0.0:{{ .Values.cockroachdb.service.httpPort }} \
              --listen-addr=0.0.0.0:{{ .Values.cockroachdb.service.sqlPort }} \
              --advertise-addr=$(hostname -f):{{ .Values.cockroachdb.service.sqlPort }} \
              --join=$JOIN_LIST \
              --cache=.25 \
              --max-sql-memory=.25
          fi
        env:
        {{- range $key, $value := .Values.cockroachdb.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
        resources:
          {{- toYaml .Values.cockroachdb.resources | nindent 10 }}
        volumeMounts:
        - name: datadir
          mountPath: /cockroach/cockroach-data
        livenessProbe:
          httpGet:
            path: /health?ready=1
            port: {{ .Values.cockroachdb.service.httpPort }}
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health?ready=1
            port: {{ .Values.cockroachdb.service.httpPort }}
          initialDelaySeconds: 10
          periodSeconds: 5
  {{- if .Values.cockroachdb.persistence.enabled }}
  volumeClaimTemplates:
  - metadata:
      name: datadir
    spec:
      accessModes:
        - {{ .Values.cockroachdb.persistence.accessMode }}
      {{- if .Values.cockroachdb.persistence.storageClass }}
      storageClassName: {{ .Values.cockroachdb.persistence.storageClass }}
      {{- end }}
      resources:
        requests:
          storage: {{ .Values.cockroachdb.persistence.size }}
  {{- end }}
