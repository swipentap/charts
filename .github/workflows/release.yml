name: Release Charts

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.17.0'

      - name: Bump chart versions (keycloak, sonarqube, plane-ce only)
        run: |
          for chart in keycloak sonarqube plane-ce; do
            f="swipentap/${chart}/Chart.yaml"
            [ -f "$f" ] || continue
            sed -i "s/^\(version: \)\(.*\)/\1\2-${{ github.run_number }}/" "$f"
            echo "Set version in $f"
          done

      - name: Helm dependency update for charts with dependencies
        run: |
          for d in swipentap/keycloak swipentap/sonarqube; do
            [ -f "${d}/Chart.yaml" ] && grep -q "dependencies:" "${d}/Chart.yaml" || continue
            echo "Running helm dependency update in $d"
            helm dependency update "$d"
          done

      - name: Package keycloak, sonarqube, plane-ce
        run: |
          rm -rf .cr-release-packages
          mkdir -p .cr-release-packages
          for chart in keycloak sonarqube plane-ce; do
            echo "Packaging swipentap/$chart..."
            helm package "swipentap/$chart" -d .cr-release-packages || { echo "ERROR: helm package failed for $chart"; exit 1; }
          done
          ls -la .cr-release-packages

      - name: Create GitHub release and upload chart packages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_tag="charts-${{ github.run_number }}"
          gh release create "$release_tag" .cr-release-packages/*.tgz --repo swipentap/charts --title "Charts ${{ github.run_number }}" --notes "Keycloak, SonarQube, Plane CE charts"
          echo "RELEASE_TAG=$release_tag" >> "$GITHUB_ENV"

      - name: Clone gh-pages and update index
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_tag="charts-${{ github.run_number }}"
          base_url="https://github.com/swipentap/charts/releases/download/${release_tag}"
          git clone --branch gh-pages --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/swipentap/charts.git" gh-pages
          cp gh-pages/index.yaml .cr-release-packages/index.yaml.bak
          helm repo index .cr-release-packages --merge .cr-release-packages/index.yaml.bak --url "$base_url"
          cp .cr-release-packages/index.yaml gh-pages/index.yaml
          cd gh-pages
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add index.yaml
          git diff --staged --quiet && echo "No index changes" || (git commit -m "Update index for $release_tag" && git push origin gh-pages)
