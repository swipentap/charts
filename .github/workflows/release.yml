name: Release Charts

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.17.0'

      - name: Bump chart versions for this run
        run: |
          for chart in keycloak sonarqube plane-ce; do
            f="swipentap/${chart}/Chart.yaml"
            if [ -f "$f" ]; then
              sed -i "s/^\(version: \)\(.*\)/\1\2-${{ github.run_number }}/" "$f"
              echo "Set version in $f"
            fi
          done

      - name: Helm dependency update for charts with dependencies
        run: |
          for d in swipentap/*/; do
            if [ -f "${d}Chart.yaml" ] && grep -q "dependencies:" "${d}Chart.yaml"; then
              echo "Running helm dependency update in $d"
              helm dependency update "$d"
            fi
          done

      - name: Verify packaging of keycloak, sonarqube, plane-ce
        run: |
          for chart in keycloak sonarqube plane-ce; do
            echo "Packaging swipentap/$chart..."
            helm package "swipentap/$chart" -d /tmp/chart-packages || { echo "ERROR: helm package failed for $chart"; exit 1; }
          done
          ls -la /tmp/chart-packages

      - name: Install chart-releaser
        run: |
          curl -sSLo cr.tar.gz "https://github.com/helm/chart-releaser/releases/download/v1.6.1/chart-releaser_1.6.1_linux_amd64.tar.gz"
          tar -xzf cr.tar.gz
          chmod +x cr
          ./cr version

      - name: Package and release (explicit to surface errors)
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          charts_dir=swipentap
          owner=swipentap
          repo=charts
          latest_tag=$(git describe --tags --abbrev=0 HEAD~ 2>/dev/null || git rev-list --max-parents=0 --first-parent HEAD | head -1)
          echo "Discovering changed charts since '$latest_tag'..."
          changed_files=$(git diff --find-renames --name-only "$latest_tag" -- "$charts_dir" || true)
          depth=$(($(echo "$charts_dir" | tr '/' '\n' | grep -v '^$' | wc -l) + 1))
          changed_charts=$(echo "$changed_files" | cut -d'/' -f"1-$depth" | sort -u | while read -r d; do [ -f "$d/Chart.yaml" ] && echo "$d"; done)
          echo "Changed charts:"
          echo "$changed_charts"
          rm -rf .cr-release-packages .cr-index
          mkdir -p .cr-release-packages .cr-index
          for chart in $changed_charts; do
            [ -d "$chart" ] || continue
            echo "Packaging $chart..."
            ./cr package "$chart" --package-path .cr-release-packages --config cr.yaml
          done
          ls -la .cr-release-packages
          echo "Uploading to GitHub Releases..."
          ./cr upload -o "$owner" -r "$repo" -c "$(git rev-parse HEAD)" --config cr.yaml --skip-existing --make-release-latest=true
          echo "Updating index..."
          ./cr index -o "$owner" -r "$repo" --push --config cr.yaml
